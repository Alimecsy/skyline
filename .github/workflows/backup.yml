name: Supabase Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run_db_backup:
    name: Run DB Backup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      BACKUP_ENABLED: ${{ vars.BACKUP_ENABLED }}

    steps:
      - name: Check if backups are enabled
        if: env.BACKUP_ENABLED != 'true'
        run: |
          echo "Backup is disabled. Exiting."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v3

      # --- WE NO LONGER NEED THE SUPABASE CLI SETUP ACTION ---
      # - name: Setup Supabase CLI
      #   uses: supabase/setup-cli@v1
      
      - name: Create backup directory
        run: mkdir -p prisma/backups

      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 dnsutils
      
      - name: Ensure pg_dumpall 17 is on PATH
        run: |
          echo "/usr/lib/postgresql/17/bin" >> $GITHUB_PATH

      - name: Verify pg_dumpall version
        run: |
          which pg_dumpall
          pg_dumpall --version
          which pg_dump
          pg_dump --version

      # --- THIS IS THE MAJOR CHANGE ---
      # We are now calling pg_dumpall and pg_dump directly,
      # bypassing the 'supabase db dump' command.

      - name: Dump database roles
        # Note: pg_dumpall uses --roles-only (plural)
        run: |
          pg_dumpall --db-url "$SUPABASE_DB_URL" --roles-only > prisma/backups/roles.sql
          
      - name: Dump database schema
        run: |
          pg_dump --db-url "$SUPABASE_DB_URL" --schema-only > prisma/backups/schema.sql

      - name: Dump database data
        run: |
          pg_dump --db-url "$SUPABASE_DB_URL" --data-only > prisma/backups/data.sql

      - name: Commit backup files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Supabase DB backup"
          file_pattern: "prisma/backups/*.sql"
