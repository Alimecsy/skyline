name: Supabase Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run_db_backup:
    name: Run DB Backup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      BACKUP_ENABLED: ${{ vars.BACKUP_ENABLED }}

    steps:
      - name: Check if backups are enabled
        if: env.BACKUP_ENABLED != 'true'
        run: |
          echo "Backup is disabled. Exiting."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create backup directory
        run: mkdir -p prisma/backups

      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 dnsutils
      
      - name: Ensure pg_dumpall 17 is on PATH
        run: |
          echo "/usr/lib/postgresql/17/bin" >> $GITHUB_PATH

      - name: Verify pg_dumpall version
        run: |
          which pg_dumpall
          pg_dumpall --version
          which pg_dump
          pg_dump --version

      # --- THIS IS THE NEW FIX ---
      # This step parses the URL and sets the standard PG environment variables
      # which pg_dump and pg_dumpall will automatically use.
      - name: Parse Connection String and Set Env Vars
        run: |
          # Extract the components from the URL: postgresql://USER:PASSWORD@HOST:PORT/DBNAME
          # Note: This regex assumes your password does not contain '@' or ':'
          echo "PGUSER=$(echo $SUPABASE_DB_URL | sed -n 's,postgresql://\([^:]*\):.*,\1,p')" >> $GITHUB_ENV
          echo "PGPASSWORD=$(echo $SUPABASE_DB_URL | sed -n 's,postgresql://[^:]*:\([^@]*\)@.*,\1,p')" >> $GITHUB_ENV
          echo "PGHOST=$(echo $SUPABASE_DB_URL | sed -n 's,postgresql://[^@]*@\([^:]*\):.*,\1,p')" >> $GITHUB_ENV
          echo "PGPORT=$(echo $SUPABASE_DB_URL | sed -n 's,postgresql://[^@]*@[^:]*:\([0-9]*\)/.*,\1,p')" >> $GITHUB_ENV
          echo "PGDATABASE=$(echo $SUPABASE_DB_URL | sed -n 's,postgresql://.*/\([^?]*\).*,\1,p')" >> $GITHUB_ENV

      # --- DUMP COMMANDS NOW USE THE ENV VARS ---
      # No connection flags are needed because the variables are set
          
      - name: Dump database roles
        run: |
          pg_dumpall --roles-only > prisma/backups/roles.sql
          
      - name: Dump database schema
        run: |
          pg_dump --schema-only > prisma/backups/schema.sql

      - name: Dump database data
        run: |
          pg_dump --data-only > prisma/backups/data.sql

      - name: Commit backup files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Supabase DB backup"
          file_pattern: "prisma/backups/*.sql"
